# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# This workflow checks out code, performs a Codacy security scan
# and integrates the results with the
# GitHub Advanced Security code scanning feature.  For more information on
# the Codacy security scan action usage and parameters, see
# https://github.com/codacy/codacy-analysis-cli-action.
# For more information on Codacy Analysis CLI in general, see
# https://github.com/codacy/codacy-analysis-cli.

# name: Test, scan, build and push image

# on:
#   push:
#     branches: [ "main" ]

# permissions:
#   contents: read


# jobs:
#   test:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v4
#     - name: Use Node.js 22.x
#       uses: actions/setup-node@v4
#       with:
#         node-version: '22.x'
#         cache: 'npm'
#     - run: npm install
#     - run: npm run test
  

  
#   build-image-and-generate-sbom:
#     permissions:
#       contents: write # for actions/checkout to fetch code
#       security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
#       actions: write
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
  
#       - name: Build the Docker image
#         run: docker build . --file Dockerfile --tag smikesword/tindahan-wise-api:v1.0.0

#       - name: Save Docker image
#         run: docker save smikesword/tindahan-wise-api:v1.0.0 -o image.tar

#       - name: Load Docker image for Syft
#         run: docker load -i image.tar
      
#       - name: Use Node.js 22.x
#         uses: actions/setup-node@v4
#         with:
#           node-version: '22.x'
#           cache: 'npm'
#       - run: npm install
#       - name: Install CycloneDX CLI
#         run: npm install --global @cyclonedx/cyclonedx-npm
#       - name: Generate nodejs(application level) SBOM
#         run: |
#           cyclonedx-npm -o node-sbom.json
#       - name: Upload node SBOM
#         uses: actions/upload-artifact@v4
#         with:
#           name: node-sbom.json
#           path: node-sbom.json

#       - name: Generate container level SBOM via Syft
#         uses: anchore/sbom-action@v0.21.1
#         with:
#           image: "smikesword/tindahan-wise-api:v1.0.0"
#           artifact-name: container-sbom.json
#           format: cyclonedx-json
#           upload-artifact: true
  
#   #For prod fail if high severity vuln is found
#   scan-node-sbom:
#     permissions:
#       contents: write # for actions/checkout to fetch code
#       security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
#       actions: write
#     needs: [build-image-and-generate-sbom]
#     runs-on: ubuntu-latest
#     steps:
#       - name: Download node SBOM
#         uses: actions/download-artifact@v4
#         with:
#           name: node-sbom.json
#       - name: Scan node SBOM with Grype
#         uses: anchore/scan-action@v7.2.3
#         with:
#           sbom: node-sbom.json
#           output-format: sarif
#           output-file: grype-node-sbom-results.sarif
#           fail-build: true
#           severity-cutoff: high
#           only-fixed: true #only report vulnerabilities that have a fix available
#       - name: Upload SBOM scan SARIF results file
#         uses: github/codeql-action/upload-sarif@v4
#         with:
#           sarif_file: grype-node-sbom-results.sarif
  
#   scan-container-sbom:
#     permissions:
#       contents: write # for actions/checkout to fetch code
#       security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
#       actions: write
#     needs: [build-image-and-generate-sbom]
#     runs-on: ubuntu-latest
#     steps:
#       - name: Download container SBOM
#         uses: actions/download-artifact@v4
#         with:
#           name: container-sbom.json
#       - name: Scan container SBOM with Grype
#         uses: anchore/scan-action@v7.2.3
#         with:
#           sbom: container-sbom.json
#           output-format: sarif
#           output-file: grype-container-sbom-results.sarif
#           fail-build: false
#           only-fixed: true #only report vulnerabilities that have a fix available
#       - name: Upload SBOM scan SARIF results file
#         uses: github/codeql-action/upload-sarif@v4
#         with:
#           sarif_file: grype-container-sbom-results.sarif
  
#   attach-sboms-and-sign-image:
#     permissions:
#       id-token: write
#       contents: write # for actions/checkout to fetch code
#       security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
#       actions: write
#     needs: [scan-node-sbom, scan-container-sbom]
#     runs-on: ubuntu-latest
#     steps:
#       - name: Download node SBOM
#         uses: actions/download-artifact@v4
#         with:
#           name: node-sbom.json
#       - name: Download container SBOM
#         uses: actions/download-artifact@v4
#         with:
#           name: container-sbom.json
#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ vars.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}
#       - name: Build and push
#         uses: docker/build-push-action@v6
#         id: build
#         with:
#           push: true
#           tags: smikesword/tindahan-wise-api:v1.0.0
#       - name: Install cosign
#         uses: sigstore/cosign-installer@v4.0.0
#       - name: attest/attach node sbom to image
#         run: |
#           cosign attest \
#           --predicate node-sbom.json \
#           --type cyclonedx \
#           smikesword/tindahan-wise-api@${{ steps.build.outputs.digest }}
#       - name: attest/attach container sbom to image
#         run: |
#           cosign attest \
#           --predicate container-sbom.json \
#           --type cyclonedx \
#           smikesword/tindahan-wise-api@${{ steps.build.outputs.digest }}
#       - name: Sign the image
#         run: |
#           cosign sign smikesword/tindahan-wise-api@${{ steps.build.outputs.digest }}
